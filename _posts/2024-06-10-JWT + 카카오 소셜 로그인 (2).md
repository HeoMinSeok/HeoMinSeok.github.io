---
title: "JWT + ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸ (2)"
date: 2024-06-10
categories: [í”„ë¡œì íŠ¸, PETSTAGRAM]
tags:
  - React
  - Spring Boot
  - JWT
  - Social Login
  - Kakao
  - OAuth2.0
---

### ğŸ“Œ Reactì™€ Spring Bootë¥¼ ì‚¬ìš©í•˜ì—¬ JWTë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¡œê·¸ì¸ ì„¸ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ê³¼ì •

### 1. Reactì—ì„œ API ìš”ì²­ 

React í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥ í›„ ë¡œê·¸ì¸ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬

<details>
<summary>ì½”ë“œ ë³´ê¸°</summary>
<div markdown="1">

```jsx
import axios from 'axios';

class UserService {
    static BASE_URL = 'http://localhost:8088';

    static async login(email, password) {
        const response = await axios.post(`${this.BASE_URL}/user/login`, {
            email,
            password,
        });
        return response.data;
    }
}
```
</div>
</details>

  > - axios.postë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸ APIë¥¼ í˜¸ì¶œ

### 2. ë¡œê·¸ì¸ ë° í† í° ì¬ë°œê¸‰ ì»¨íŠ¸ë¡¤ëŸ¬
ì„œë²„ë‹¨ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œëŠ” ë¡œê·¸ì¸ ë° í† í° ì¬ë°œê¸‰ ìš”ì²­ì„ ì²˜ë¦¬

<details>
<summary>ì½”ë“œ ë³´ê¸°</summary>
<div markdown="1">

```java
@RestController
@RequiredArgsConstructor
@RequestMapping("/user")
public class UserController {

    private UserService userService;

    @PostMapping("/login")
    public ResponseEntity<UserDTO> login(@RequestBody UserDTO userDTO) {
        return ResponseEntity.ok(userService.login(userDTO));
    }

    // ìƒˆë¡œê³ ì¹¨ í† í°
    @PostMapping("/refresh")
    public ResponseEntity<UserDTO> refreshToken(@RequestBody UserDTO userDTO) {
        return ResponseEntity.ok(userService.refreshToken(userDTO));
    }
}
```
</div>
</details>

> - `/login` ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì‚¬ìš©ì ì¸ì¦ í›„ JWT í† í°ì„ ë°˜í™˜
> - `/refresh` ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ìƒˆë¡œê³ ì¹¨ í† í°ì„ ì‚¬ìš©í•´ ìƒˆë¡œìš´ JWT í† í°ì„ ë°˜í™˜

### 3. UserService í´ë˜ìŠ¤

`UserService` í´ë˜ìŠ¤ì—ì„œëŠ” ì‚¬ìš©ì ë¡œê·¸ì¸ ë° í† í° ì¬ë°œê¸‰ ë¡œì§ì„ êµ¬í˜„

<details>
<summary>ì½”ë“œ ë³´ê¸°</summary>
<div markdown="1">

```java

public class UserService {
    public UserDTO login(UserDTO userDTO) {
        authenticationManager.authenticate(
            new UsernamePasswordAuthenticationToken(userDTO.getEmail(), userDTO.getPassword())
        );

        UserEntity user = userRepository.findByEmail(userDTO.getEmail())
            .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼: " + userDTO.getEmail()));

        // ì¡°íšŒëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ JWT í† í° ìƒì„±
        String jwt = jwtUtils.generateToken(user);

        // ë¹„ì–´ìˆëŠ” ë§µê³¼ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ í† í° ìƒì„±
        String refreshToken = jwtUtils.generateRefreshToken(new HashMap<>(), user);

        UserDTO response = UserDTO.toDTO(user);
        response.setToken(jwt);
        response.setRole(user.getRole());
        response.setRefreshToken(refreshToken);

        return response;
    }

    public UserDTO refreshToken(UserDTO userDTO) {
        UserDTO response = new UserDTO();

        // í† í°ì—ì„œ ì‚¬ìš©ì ì´ë©”ì¼ ì¶”ì¶œ
        String ourEmail = jwtUtils.extractUsername(userDTO.getToken());

        // ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ, ì—†ìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ
        UserEntity users = userRepository.findByEmail(ourEmail)
            .orElseThrow(() -> new UsernameNotFoundException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼: " + ourEmail));

        // í† í° ìœ íš¨ì„± ê²€ì‚¬ í›„ ìœ íš¨í•˜ë‹¤ë©´ ìƒˆë¡œìš´ í† í° ìƒì„±
        if (jwtUtils.isTokenValid(userDTO.getToken(), users)) {
            String jwt = jwtUtils.generateToken(users);
            response.setToken(jwt); 
            response.setRefreshToken(userDTO.getToken());   
        }

        return response;
    }

}
```
</div>
</details>

> - ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•˜ê³  JWT ë° ìƒˆë¡œê³ ì¹¨ í† í°ì„ ìƒì„±
> - ìƒˆë¡œê³ ì¹¨ í† í° ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê³ , ìœ íš¨í•˜ë‹¤ë©´ ìƒˆë¡œìš´ JWTë¥¼ ìƒì„±

### 4. JWTUtils í´ë˜ìŠ¤

`JWTUtils` í´ë˜ìŠ¤ì—ì„œëŠ” JWT ìƒì„± ë° ê²€ì¦ì— í•„ìš”í•œ ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œë¥¼ êµ¬í˜„

<details>
<summary>ì½”ë“œ ë³´ê¸°</summary>
<div markdown="1">

```java
package com.petstagram.service.utils;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;
import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.Date;
import java.util.HashMap;
import java.util.function.Function;

@Component
public class JWTUtils {

    private SecretKey key;
    private static final long ACCESS_TOKEN_EXPIRATION_TIME = 1800000; // 30ë¶„
    private static final long REFRESH_TOKEN_EXPIRATION_TIME = 604800000; // 7ì¼

    public JWTUtils(@Value("${jwt.secret}") String secretString) {
        byte[] keyBytes = Base64.getDecoder().decode(secretString.getBytes(StandardCharsets.UTF_8));
        this.key = new SecretKeySpec(keyBytes, "HmacSHA256");
    }

    public String generateToken(UserDetails userDetails){
        return Jwts.builder()
                .setSubject(userDetails.getUsername())
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + ACCESS_TOKEN_EXPIRATION_TIME))
                .signWith(key)
                .compact();
    }

    public String generateRefreshToken(HashMap<String, Object> claims, UserDetails userDetails){
        return Jwts.builder()
                .setClaims(claims)
                .setSubject(userDetails.getUsername())
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + REFRESH_TOKEN_EXPIRATION_TIME))
                .signWith(key)
                .compact();
    }

    public String extractUsername(String token){
        return extractClaims(token, Claims::getSubject);
    }

    private <T> T extractClaims(String token, Function<Claims, T> claimsResolver){
        return claimsResolver.apply(Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token).getBody());
    }

    public boolean isTokenValid(String token, UserDetails userDetails){
        final String username = extractUsername(token);
        return (username.equals(userDetails.getUsername()) && !isTokenExpired(token));
    }

    public boolean isTokenExpired(String token){
        return extractClaims(token, Claims::getExpiration).before(new Date());
    }
}

```
</div>
</details>

> - `generateToken` ë©”ì„œë“œëŠ” ì•¡ì„¸ìŠ¤ í† í°ì„ ìƒì„±
> - `generateRefreshToken` ë©”ì„œë“œëŠ” ìƒˆë¡œê³ ì¹¨ í† í°ì„ ìƒì„±
> - `extractUsername` ë©”ì„œë“œëŠ” í† í°ì—ì„œ ì‚¬ìš©ì ì´ë¦„ì„ ì¶”ì¶œ
> - `isTokenValid` ë©”ì„œë“œëŠ” í† í° ìœ íš¨ì„±ì„ ê²€ì‚¬í•©ë‹ˆë‹¤.ì¶œ

### 5. OurUserDetailsService í´ë˜ìŠ¤

`OurUserDetailsService` í´ë˜ìŠ¤ëŠ” ì‚¬ìš©ì ì¸ì¦ì— í•„ìš”í•œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ

<details>
<summary>ì½”ë“œ ë³´ê¸°</summary>
<div markdown="1">

```java
package com.petstagram.service.utils;

import com.petstagram.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

@Service
public class OurUserDetailsService implements UserDetailsService {

    @Autowired
    private UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        return userRepository.findByEmail(username)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. email = " + username));
    }
}

```
</div>
</details>

> - `loadUserByUsername` ë©”ì„œë“œëŠ” ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒ
